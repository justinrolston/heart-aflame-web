<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Devotional - Heart Aflame</title>
    <link rel="icon" type="image/png" href="../icon.png">
    <link rel="stylesheet" href="../devotional-shared.css">
</head>
<body>
    <header class="header">
        <div class="container">
            <nav class="nav">
                <a href="/" class="logo">
                    <div class="logo-icon">
                        <img src="../icon.png" alt="Heart Aflame Icon">
                    </div>
                    <span class="logo-text">Heart Aflame</span>
                </a>
                <ul class="nav-links">
                    <li><a href="/">Home</a></li>
                    <li><a href="/today">Today</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <div id="loading" class="loading">
                <div class="loading-spinner"></div>
                <p class="loading-text">Loading devotional...</p>
            </div>

            <div id="error" class="error" style="display: none;">
                <div class="error-icon">⚠️</div>
                <h2 class="error-title">Unable to Load Devotional</h2>
                <p class="error-message" id="error-message">We encountered an error loading this devotional. Please try again.</p>
                <button class="retry-button" onclick="loadDevotional()">Retry</button>
            </div>

            <div id="devotional-content" class="devotional-container" style="display: none;">
                <!-- Content will be populated by JavaScript -->
            </div>
        </div>
    </main>

    <script src="../devotional-shared.js"></script>
    <script>
        // Parse date from URL query string or default to today
        function getDateFromUrl() {
            const urlParams = new URLSearchParams(window.location.search);
            const dateParam = urlParams.get('date');

            if (dateParam) {
                return dateParam;
            }

            // Default to today if no date in URL
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        // Load devotional from API
        async function loadDevotional() {
            const loadingEl = document.getElementById('loading');
            const errorEl = document.getElementById('error');
            const contentEl = document.getElementById('devotional-content');

            // Reset states
            loadingEl.style.display = 'block';
            errorEl.style.display = 'none';
            contentEl.style.display = 'none';

            try {
                const dateString = getDateFromUrl();

                // Validate date
                if (!isValidDate(dateString)) {
                    // Redirect to 404
                    window.location.href = '/404.html';
                    return;
                }

                const response = await fetch(`https://admin.heartafla.me/api/v1/devo/${dateString}`);

                if (!response.ok) {
                    if (response.status === 404) {
                        // Redirect to 404 page
                        window.location.href = '/404.html';
                        return;
                    } else if (response.status === 400) {
                        window.location.href = '/404.html';
                        return;
                    } else {
                        throw new Error('Failed to load devotional. Please try again later.');
                    }
                }

                const data = await response.json();
                renderDevotional(data);

                loadingEl.style.display = 'none';
                contentEl.style.display = 'block';
            } catch (error) {
                console.error('Error loading devotional:', error);
                loadingEl.style.display = 'none';
                errorEl.style.display = 'block';
                document.getElementById('error-message').textContent = error.message;
            }
        }

        // Load devotional on page load
        loadDevotional();
    </script>
</body>
</html>
